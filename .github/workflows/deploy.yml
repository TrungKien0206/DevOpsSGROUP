name: CI/CD test # TÃªn cá»§a workflow sáº½ hiá»ƒn thá»‹ trong tab Actions trÃªn GitHub

on:
  push:
    branches: [main] # KÃ­ch hoáº¡t workflow khi cÃ³ code Ä‘Æ°á»£c push vÃ o nhÃ¡nh main
  pull_request:
    branches: [main] # KÃ­ch hoáº¡t khi cÃ³ pull request má»Ÿ/merge vÃ o nhÃ¡nh main

jobs:
  build-and-deploy: # TÃªn cá»§a job chÃ­nh
    runs-on: ubuntu-latest # Cháº¡y job trÃªn mÃ¡y áº£o Ubuntu má»›i nháº¥t

    steps:
      - name: â¬ Checkout code
        uses: actions/checkout@v4 # BÆ°á»›c nÃ y láº¥y mÃ£ nguá»“n tá»« repository vá» runner

      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v4 # DÃ¹ng action Ä‘á»ƒ cÃ i Ä‘áº·t Node.js
        with:
          node-version: "22" # CÃ i Node.js phiÃªn báº£n 22 (phÃ¹ há»£p vá»›i app)

      - name: ğŸ“¦ Install dependencies
        run: npm install # CÃ i Ä‘áº·t táº¥t cáº£ package tá»« package.json

      - name: ğŸ” Log in to DockerHub
        uses: docker/login-action@v3 # DÃ¹ng GitHub Action chÃ­nh thá»©c Ä‘á»ƒ login DockerHub
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # TÃªn tÃ i khoáº£n DockerHub Ä‘Æ°á»£c lÆ°u trong GitHub Secrets
          password: ${{ secrets.DOCKERHUB_TOKEN }} # Token DockerHub (khÃ´ng pháº£i password tháº­t)

      - name: ğŸ³ Build Docker image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/demoexpress:latest .
        # Build Docker image tá»« Dockerfile á»Ÿ thÆ° má»¥c gá»‘c vÃ  gáº¯n tag latest

      - name: ğŸ“¤ Push Docker image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/demoexpress:latest
        # Äáº©y image vá»«a build lÃªn DockerHub

      - name: ğŸ” Setup SSH to EC2
        run: |
          mkdir -p ~/.ssh  # Táº¡o thÆ° má»¥c .ssh náº¿u chÆ°a cÃ³
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa  # Táº¡o file private key tá»« biáº¿n secret
          chmod 600 ~/.ssh/id_rsa  # Äáº·t quyá»n riÃªng tÆ° cho file key (báº¯t buá»™c)
          ssh-keyscan -H 47.128.251.53 >> ~/.ssh/known_hosts  # ThÃªm host key cá»§a EC2 vÃ o known_hosts Ä‘á»ƒ trÃ¡nh cáº£nh bÃ¡o khi SSH

      - name: ğŸš€ Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@47.128.251.53 << 'EOF'
            cd ~/DevOpsSGROUP  # Truy cáº­p thÆ° má»¥c chá»©a source code trÃªn EC2
            git pull origin main  # Láº¥y code má»›i nháº¥t tá»« GitHub repo (Ä‘Ã£ clone tá»« trÆ°á»›c)
            docker-compose down  # Táº¯t toÃ n bá»™ container Ä‘ang cháº¡y (náº¿u cÃ³)
            docker-compose up -d --build  # Build láº¡i vÃ  cháº¡y cÃ¡c container má»›i á»Ÿ cháº¿ Ä‘á»™ detached
          EOF  # Káº¿t thÃºc khá»‘i lá»‡nh SSH
